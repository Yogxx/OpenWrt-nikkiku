name: cleanup workflow runs

on:
  workflow_dispatch:
    inputs:
      keep:
        description: "Jumlah workflow run TERBARU yang disimpan"
        required: false
        default: "5"

permissions:
  actions: write
  contents: read

jobs:
  cleanup:
    name: delete old workflow runs
    runs-on: ubuntu-latest

    steps:
      - name: show inputs
        run: |
          echo "Keep latest runs: ${{ github.event.inputs.keep }}"

      - name: cleanup workflow runs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          KEEP=${{ github.event.inputs.keep }}
          echo "Keeping latest $KEEP runs per workflow"

          gh run list --limit 1000 --json databaseId,workflowName,createdAt \
          | jq -r '.[] | "\(.workflowName) \(.databaseId) \(.createdAt)"' \
          | sort -k1,1 -k3,3r \
          | awk -v keep="$KEEP" '
            {
              count[$1]++
              if (count[$1] > keep) print $2
            }' \
          | while read id; do
              echo "Deleting run ID $id"
              gh run delete "$id"
            done
