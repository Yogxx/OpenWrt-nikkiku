name: test-packages

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "OpenWrt branch"
        required: true
        type: choice
        options:
          - openwrt-23.05
          - openwrt-24.10
          - openwrt-25.12
        default: openwrt-24.10

      arch:
        description: "Target architecture"
        required: true
        type: choice
        options:
          - arm_cortex-a9
          - aarch64_cortex-a53
          - aarch64_cortex-a72
          - aarch64_cortex-a76
          - aarch64_generic
          - x86_64
        default: x86_64

env:
  FEEDNAME: nikki
  PACKAGES: luci-app-nikki

jobs:
  build:
    name: test build ${{ inputs.arch }} ${{ inputs.branch }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: show selected target
        run: |
          echo "OpenWrt branch : ${{ inputs.branch }}"
          echo "Target arch    : ${{ inputs.arch }}"

      - name: build packages (test)
        uses: openwrt/gh-action-sdk@main
        env:
          ARCH: ${{ inputs.arch }}-${{ inputs.branch }}
          FEEDNAME: ${{ env.FEEDNAME }}
          PACKAGES: ${{ env.PACKAGES }}
          INDEX: 0
          NO_REFRESH_CHECK: true

      - name: list built packages
        run: |
          echo "Built packages:"
          find bin/packages -type f \( -name "*.ipk" -o -name "*.apk" \) || true
          
